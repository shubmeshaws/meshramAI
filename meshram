#!/bin/bash

VERSION="v1.0"
echo "ðŸ”§ Meshram Infra CLI $VERSION"

set -e
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"



LOG_FILE="SCRIPT_DIR/logs/infra.log"
SCRIPTS_DIR="SCRIPT_DIR/scripts"

mkdir -p "./logs"

function show_help() {
  echo "Usage: meshram [COMMAND]"
  echo ""
  echo "Commands:"
  echo "  create vpc                 - Create a VPC with subnets and NAT"
  echo "  create ec2                 - Launch an EC2 instance"
  echo "  create s3 <bucket> <region> - Create an S3 bucket"
  echo "  help                      - Show this help message"
}

case "$1" in
  create)
    case "$2" in
      vpc)
        echo "[INFO] Running VPC creation script..." | tee -a "$LOG_FILE"
        bash "$SCRIPTS_DIR/create_vpc.sh" | tee -a "$LOG_FILE"
        ;;
      ec2)
        echo "[INFO] Running EC2 creation script..." | tee -a "$LOG_FILE"
        bash "$SCRIPTS_DIR/create_ec2.sh" | tee -a "$LOG_FILE"
        ;;
      s3)
        if [[ -z "$3" || -z "$4" ]]; then
          echo "[ERROR] Missing arguments for S3 creation."
          echo "Usage: meshram create s3 <bucket-name> <region>"
          exit 1
        fi
        BUCKET_NAME="$3"
        REGION="$4"
        echo "[INFO] Running S3 creation script for bucket '$BUCKET_NAME' in region '$REGION'..." | tee -a "$LOG_FILE"
        bash "$SCRIPTS_DIR/create_s3.sh" "$BUCKET_NAME" "$REGION" | tee -a "$LOG_FILE"
        ;;
      *)
        echo "[ERROR] Unknown create target: $2"
        show_help
        ;;
    esac
    ;;
  help|--help|-h)
    show_help
    ;;
  *)
    echo "[ERROR] Invalid command: $1"
    show_help
    ;;
esac
